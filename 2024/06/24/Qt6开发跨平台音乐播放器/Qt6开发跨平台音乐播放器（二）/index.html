<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Qt6开发跨平台音乐播放器（二）：单例模式 | Lin Qiaqun&#39;s blog | Welcome to my blog</title>

  
  <meta name="author" content="Lin Qiaqun">
  

  
  <meta name="description" content="Qt6开发跨平台音乐播放器教程">
  

  
  
  <meta name="keywords" content="Qt6,跨平台,音乐播放器,QMultiMedia">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="Qt6开发跨平台音乐播放器（二）：单例模式"/>

  <meta property="og:site_name" content="Lin Qiaqun&#39;s blog"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Lin Qiaqun&#39;s blog" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
<meta name="generator" content="Hexo 7.2.0"></head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">Lin Qiaqun&#39;s blog</a>
    </h1>
    <p class="site-description">Welcome to my blog</p>
  </div>
  <nav class="site-navigation">
    <ul>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>Qt6开发跨平台音乐播放器（二）：单例模式</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2024/06/24/Qt6开发跨平台音乐播放器/Qt6开发跨平台音乐播放器（二）/" rel="bookmark">
        <time class="entry-date published" datetime="2024-06-24T06:43:00.677Z">
          2024-06-24
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h2 id="1-C-实现方案"><a href="#1-C-实现方案" class="headerlink" title="1. C++实现方案"></a>1. C++实现方案</h2><p>开发客户端程序少不了要用到单例模式（Singleton Pattern），核心就是创建一个全局唯一的实例，根据创建实例的时机，可以分类成：</p>
<ul>
<li><p>饿汉式 - 程序启动就创建实例</p>
</li>
<li><p>懒汉式 - 调用时再创建实例</p>
</li>
</ul>
<p>在C++11之前，为了实现线程安全，兼顾性能效率，又衍生出了懒汉式+双检测锁这种实现。</p>
<p>而C++11之后，引入了std::call_once特性，确保函数在多线程并发情况下，只执行一次，完美地替换双检测锁：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;memory&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Singleton</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">static</span> Singleton &amp;<span class="title">instance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="type">static</span> std::once_flag flag;</span><br><span class="line">        std::<span class="built_in">call_once</span>(flag, [&amp;]() &#123;</span><br><span class="line">            obj.<span class="built_in">reset</span>(<span class="keyword">new</span> Singleton);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> *obj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">static</span> std::unique_ptr&lt;Singleton&gt; obj;</span><br><span class="line">    <span class="built_in">Singleton</span>() = defaut;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>另外，C++11还引入了线程安全的局部静态变量，单例的实现方式更为简单：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Singleton</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">static</span> Singleton &amp;<span class="title">instance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="type">static</span> Singleton obj;</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="built_in">Singleton</span>() = defaut;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-Qt实现方案"><a href="#2-Qt实现方案" class="headerlink" title="2. Qt实现方案"></a>2. Qt实现方案</h2><p>除了上述的C++实现方案，Qt还提供了一个Q_GLOBAL_STATIC宏来实现线程安全的单例，具体描述可以参考Qt文档：<a target="_blank" rel="noopener" href="https://doc.qt.io/qt-6/qglobalstatic.html">QGlobalStatic Struct | Qt Core 6.7.2</a></p>
<p>使用方式如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// singleton.h</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Singleton</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Singleton</span>();</span><br><span class="line">    ~<span class="built_in">Singleton</span>();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">static</span> Singleton* <span class="title">instance</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// singleton.cpp</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;singleton.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QGlobalStatic&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">Q_GLOBAL_STATIC</span>(Singleton, singleton)</span><br><span class="line"></span><br><span class="line"><span class="function">Singleton* <span class="title">Singleton::instance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">singleton</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用Q_GLOBAL_STATIC要求类的构造和析构函数为public，这样就无法防止构造新的实例，在使用时需要注意这一点。</p>
<hr>
<p>PS: 代码已经开源在github：<a target="_blank" rel="noopener" href="https://github.com/linqiaqun/music-player">linqiaqun&#x2F;music-player: A cross platform music player (github.com)</a> 欢迎star&#x2F;fork&#x2F;issue</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/Qt6/">Qt6</a><a href="/tags/跨平台/">跨平台</a><a href="/tags/音乐播放器/">音乐播放器</a><a href="/tags/QMultiMedia/">QMultiMedia</a>
    </span>
    

    </div>

    
  </div>
</article>

  









    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2024 Lin Qiaqun
    
  </p>
</footer>
    
    
  </div>
</div>
</body>
</html>